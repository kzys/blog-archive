box: starefossen/ruby-node

build:
  steps:
    - script:
        name: Install git and rsync
        code: |
            apt-get update
            apt-get install -y git rsync
    - add-ssh-key:
        keyname: KEY_NAME
    - add-to-known_hosts:
        hostname: github.com
        fingerprint: 16:27:ac:a5:76:28:2d:36:63:1b:56:4d:eb:df:a6:48
    - add-to-known_hosts:
        hostname: bitbucket.org
        fingerprint: 3f:d3:c5:17:23:3c:cd:f5:2d:17:76:06:93:7e:ee:97:42:21:14:aa
    - script:
        name: 'Workaround for "Host key verification failed"'
        code: ssh -o StrictHostKeyChecking=no git@bitbucket.org
    - script:
        name: initialize git submodules
        code: |
            git submodule update --init --recursive
    - bundle-install
    - npm-install
    - script:
        code: LANG=en_US.UTF-8 RUBYOPT=-EUTF-8 bundle exec rake publish

deploy:
  steps:
    - s3sync:
        source_dir: build/public
        delete-removed: true
        bucket-url: $AWS_BUCKET_URL
        key-id: $AWS_ACCESS_KEY_ID
        key-secret: $AWS_SECRET_ACCESS_KEY
        opts: --default-mime-type=text/html --acl-public
